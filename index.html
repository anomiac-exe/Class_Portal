<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Appreciation Envelope | Class of 2025</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&family=Caveat:wght@500;700&family=Playfair+Display:ital,wght@0,600;1,600&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }
        .glass { 
            background: rgba(255, 255, 255, 0.92); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.8); 
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.1);
        }
        .rtl { direction: rtl; text-align: right; }
        .ltr { direction: ltr; text-align: left; }
        
        /* Smooth Animations */
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- VISUAL STATIONERY STYLES --- */
        
        /* 1. Yellow Sticky Note */
        .paper-sticky {
            background-color: #fef08a; /* Yellow-200 */
            color: #422006;
            font-family: 'Caveat', cursive;
            font-size: 1.25rem;
            transform: rotate(-1deg);
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
            border-bottom-right-radius: 40px 5px;
        }

        /* 2. Lined Notebook Page */
        .paper-lined {
            background-color: #fff;
            background-image: linear-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 100% 1.5rem; /* Line height */
            color: #334155;
            font-family: 'Plus Jakarta Sans', sans-serif;
            border-left: 4px solid #f43f5e; /* Margin line */
            line-height: 1.5rem;
            padding-top: 0.2rem;
        }

        /* 3. Elegant Card */
        .paper-elegant {
            background-color: #fafaf9; /* Warm grey */
            color: #1c1917;
            font-family: 'Playfair Display', serif;
            border: 1px solid #d6d3d1;
            border-radius: 4px;
            text-align: center;
            font-style: italic;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        
        /* 4. Minimalist Tech */
        .paper-minimal {
            background-color: #fff;
            border-left: 4px solid #6366f1; /* Indigo */
            color: #1e293b;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        /* Toast Notification */
        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
            pointer-events: none;
        }
        .toast {
            background: #1e293b;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(20px);
        }
        .toast.show { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-4 text-slate-800">

    <div id="app" class="w-full max-w-md relative z-10"></div>

    <div id="toast-container">
        <div id="toast" class="toast">
            <span class="text-xl">ğŸ’Œ</span> <span id="toast-msg">New message received!</span>
        </div>
    </div>

    <div class="fixed bottom-4 text-center w-full max-w-md px-6 pointer-events-none opacity-60 z-0">
        <p class="text-[10px] text-slate-400 uppercase tracking-widest" id="privacyText">
            ğŸ”’ 100% Anonymous â€¢ Zero-Knowledge Protocol
        </p>
    </div>

    <script>
        // --- 3. CONFIGURATION ---
        const SB_URL = 'https://ijgtdeffemmvuezkkfri.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlqZ3RkZWZmZW1tdnVlemtrZnJpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMTI5MzEsImV4cCI6MjA4MjU4ODkzMX0.x-nO59Smnq2Sk-Q_rVOM3oPuVmur5nTpgwZntJJEFxY';
        
        const db = window.supabase.createClient(SB_URL, SB_KEY);

        // --- 4. STATE & TRANSLATIONS ---
        let state = {
            view: 'welcome',
            lang: 'en',
            user: null,
            students: [],
            messages: [],
            searchQuery: '',
            realtimeSub: null
        };

        const content = {
            en: {
                maxwellTitle: "A Single Word Can Change a Life",
                maxwellBody: "Years ago, a teacher asked her class to write down the best quality of every other student. Decades later, a soldier killed in war was found with that folded paper in his pocket. It was his most prized possession. Today, we recreate that list.",
                btnStart: "Enter Portal",
                loginTitle: "Identify Yourself",
                phName: "Full Name (e.g. Achour Yacine)",
                phPass: "Secret Password",
                btnLogin: "Access My Envelope",
                welcome: "Hello,",
                empty: "Your envelope is waiting for its first letter.",
                btnSend: "Send Appreciation",
                btnDl: "Download Certificate (PDF)",
                writeTitle: "Who inspires you?",
                phSearch: "Search for a classmate...",
                phMsg: "Write something genuine. What do you admire about them? A small compliment can mean the world.",
                btnSubmit: "Send Anonymously",
                privacy: "ğŸ”’ Strictly Anonymous: Even the administrators cannot see who sent a message. Be kind, be real.",
                alertSent: "Your kindness has been delivered.",
                alertPassSet: "Password secured! Don't forget it.",
                alertPassErr: "Incorrect password.",
                newMsg: "You have a new letter! ğŸ’Œ"
            },
            fr: {
                maxwellTitle: "Un seul mot peut changer une vie",
                maxwellBody: "Il y a des annÃ©es, une enseignante a demandÃ© Ã  sa classe d'Ã©crire la meilleure qualitÃ© de chaque Ã©lÃ¨ve. Des dÃ©cennies plus tard, on a retrouvÃ© cette liste dans la poche d'un soldat tombÃ© au combat. C'Ã©tait son bien le plus prÃ©cieux. Aujourd'hui, nous recrÃ©ons cette liste.",
                btnStart: "Entrer",
                loginTitle: "Identifiez-vous",
                phName: "Nom complet (ex. Achour Yacine)",
                phPass: "Mot de passe secret",
                btnLogin: "AccÃ©der Ã  mon enveloppe",
                welcome: "Bonjour,",
                empty: "Votre enveloppe attend sa premiÃ¨re lettre.",
                btnSend: "Envoyer de la reconnaissance",
                btnDl: "TÃ©lÃ©charger Certificat (PDF)",
                writeTitle: "Qui vous inspire ?",
                phSearch: "Chercher un camarade...",
                phMsg: "Ã‰crivez quelque chose de sincÃ¨re. Qu'admirez-vous chez cette personne ?",
                btnSubmit: "Envoyer Anonymement",
                privacy: "ğŸ”’ Strictement Anonyme : MÃªme les administrateurs ne peuvent pas voir l'expÃ©diteur.",
                alertSent: "Votre message a Ã©tÃ© livrÃ©.",
                alertPassSet: "Mot de passe sÃ©curisÃ© !",
                alertPassErr: "Mot de passe incorrect.",
                newMsg: "Nouveau message reÃ§u ! ğŸ’Œ"
            },
            ar: {
                maxwellTitle: "ÙƒÙ„Ù…Ø© ÙˆØ§Ø­Ø¯Ø© Ù‚Ø¯ ØªØºÙŠØ± Ø­ÙŠØ§Ø© Ø¨Ø£ÙƒÙ…Ù„Ù‡Ø§",
                maxwellBody: "Ø°Ø§Øª Ù…Ø±Ø©ØŒ Ø·Ù„Ø¨Øª Ù…Ø¹Ù„Ù…Ø© Ù…Ù† Ø·Ù„Ø§Ø¨Ù‡Ø§ Ø£Ù† ÙŠÙƒØªØ¨ÙˆØ§ Ø£Ø¬Ù…Ù„ ØµÙØ© ÙÙŠ ÙƒÙ„ Ø²Ù…ÙŠÙ„ Ù„Ù‡Ù…. Ø¨Ø¹Ø¯ Ø³Ù†ÙˆØ§ØªØŒ Ø¹ÙØ«Ø± Ø¹Ù„Ù‰ ØªÙ„Ùƒ Ø§Ù„ÙˆØ±Ù‚Ø© ÙÙŠ Ø¬ÙŠØ¨ Ø£Ø­Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø°ÙŠ ØªÙˆÙÙŠ ÙÙŠ Ø§Ù„Ø­Ø±Ø¨ØŒ ÙˆÙƒØ§Ù†Øª Ø£ØºÙ„Ù‰ Ù…Ø§ ÙŠÙ…Ù„Ùƒ. Ø§Ù„ÙŠÙˆÙ…ØŒ Ù†Ø­Ù† Ù†Ø¹ÙŠØ¯ Ø¥Ø­ÙŠØ§Ø¡ ØªÙ„Ùƒ Ø§Ù„Ù„Ø­Ø¸Ø©.",
                btnStart: "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø±Ø­Ù„Ø©",
                loginTitle: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
                phName: "Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ (Ù…Ø«Ø§Ù„: Ø¹Ø§Ø´ÙˆØ± ÙŠØ§Ø³ÙŠÙ†)",
                phPass: "ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±",
                btnLogin: "ÙØªØ­ Ù…ØºÙ„ÙÙŠ Ø§Ù„Ø®Ø§Øµ",
                welcome: "Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ",
                empty: "Ù…ØºÙ„ÙÙƒ ÙŠÙ†ØªØ¸Ø± Ø£ÙˆÙ„ Ø±Ø³Ø§Ù„Ø© ØªÙ‚Ø¯ÙŠØ±.",
                btnSend: "Ø£Ø±Ø³Ù„ ÙƒÙ„Ù…Ø© Ø·ÙŠØ¨Ø©",
                btnDl: "ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© (PDF)",
                writeTitle: "Ù…Ù† ÙŠØ³ØªØ­Ù‚ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ØŸ",
                phSearch: "Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù…...",
                phMsg: "Ø£ÙƒØªØ¨ Ø´ÙŠØ¦Ø§Ù‹ Ù†Ø§Ø¨Ø¹Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ù„Ø¨. Ù…Ø§ Ø§Ù„Ø°ÙŠ ÙŠØ¹Ø¬Ø¨Ùƒ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ø®ØµØŸ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø·ÙŠØ¨Ø© ØµØ¯Ù‚Ø©.",
                btnSubmit: "Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø³Ø±ÙŠØ© ØªØ§Ù…Ø©",
                privacy: "ğŸ”’ Ø³Ø±ÙŠØ© Ù…Ø·Ù„Ù‚Ø©: Ø­ØªÙ‰ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† Ø¹Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ù‡Ù… Ù…Ø¹Ø±ÙØ© Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø±Ø³Ù„. ÙƒÙ† ØµØ§Ø¯Ù‚Ø§Ù‹ ÙˆÙ„Ø·ÙŠÙØ§Ù‹.",
                alertSent: "ØªÙ… Ø¥ÙŠØµØ§Ù„ Ø±Ø³Ø§Ù„ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­.",
                alertPassSet: "ØªÙ… Ø­ÙØ¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø¨Ù†Ø¬Ø§Ø­!",
                alertPassErr: "ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.",
                newMsg: "ÙˆØµÙ„ØªÙƒ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©! ğŸ’Œ"
            }
        };

        // --- 5. RENDER ENGINE ---
        function setView(v) { state.view = v; render(); }
        function setLang(l) { state.lang = l; render(); }

        // Helper: Get Random Stationery Class
        function getPaperStyle(index) {
            const styles = ['paper-sticky', 'paper-lined', 'paper-elegant', 'paper-minimal'];
            // Use index to make it deterministic (so it doesn't change on re-render)
            return styles[index % styles.length];
        }

        function render() {
            const app = document.getElementById('app');
            const t = content[state.lang];
            const dir = state.lang === 'ar' ? 'rtl' : 'ltr';
            const font = state.lang === 'ar' ? "font-family: 'Plus Jakarta Sans', sans-serif;" : "";

            document.getElementById('privacyText').innerText = t.privacy;

            // 1. WELCOME
            if (state.view === 'welcome') {
                app.innerHTML = `
                    <div class="glass p-8 rounded-[2rem] shadow-2xl space-y-8 ${dir} fade-in" style="${font}">
                        <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto shadow-inner">
                            <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                        </div>
                        <div class="text-center space-y-4">
                            <h1 class="text-2xl font-bold text-slate-900 leading-tight">${t.maxwellTitle}</h1>
                            <p class="text-slate-600 text-sm leading-relaxed">${t.maxwellBody}</p>
                        </div>
                        <button onclick="setView('login')" class="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-2xl shadow-lg transform transition active:scale-95">${t.btnStart}</button>
                        <div class="flex justify-center gap-6 pt-2">
                            <button onclick="setLang('en')" class="text-xs font-bold tracking-wider ${state.lang==='en'?'text-indigo-600':'text-slate-400'}">EN</button>
                            <button onclick="setLang('fr')" class="text-xs font-bold tracking-wider ${state.lang==='fr'?'text-indigo-600':'text-slate-400'}">FR</button>
                            <button onclick="setLang('ar')" class="text-xs font-bold tracking-wider ${state.lang==='ar'?'text-indigo-600':'text-slate-400'}">Ø¹Ø±Ø¨ÙŠ</button>
                        </div>
                    </div>
                `;
            }

            // 2. LOGIN
            else if (state.view === 'login') {
                app.innerHTML = `
                    <div class="glass p-8 rounded-[2rem] shadow-2xl space-y-6 ${dir} fade-in">
                        <div class="text-center">
                            <h2 class="text-xl font-bold text-slate-800">${t.loginTitle}</h2>
                        </div>
                        <div class="space-y-3">
                            <input id="nameInput" type="text" placeholder="${t.phName}" class="w-full p-4 bg-white/50 border border-white rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none transition text-slate-800 placeholder-slate-400">
                            <input id="passInput" type="password" placeholder="${t.phPass}" class="w-full p-4 bg-white/50 border border-white rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none transition text-slate-800 placeholder-slate-400">
                        </div>
                        <button onclick="handleLogin()" class="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-2xl shadow-lg transform transition active:scale-95">${t.btnLogin}</button>
                        <button onclick="setView('welcome')" class="w-full text-center text-xs text-slate-400 hover:text-slate-600">Back</button>
                    </div>
                `;
            }

            // 3. DASHBOARD
            else if (state.view === 'dashboard') {
                // Generate Messages with Stationery Styles
                const msgList = state.messages.map((m, i) => `
                    <div class="p-5 mb-4 rounded-xl ${getPaperStyle(i)} pop-in" style="animation-delay: ${i * 0.1}s">
                        <p class="text-sm leading-relaxed">"${m.content}"</p>
                    </div>
                `).join('');

                app.innerHTML = `
                    <div class="space-y-4 ${dir} fade-in w-full">
                        <div class="flex justify-between items-center px-4">
                            <h2 class="text-lg font-bold text-slate-900">${t.welcome} ${state.user.Full_name.split(' ')[0]}</h2>
                            <button onclick="location.reload()" class="w-8 h-8 flex items-center justify-center bg-red-50 text-red-400 rounded-full hover:bg-red-100 transition">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                            </button>
                        </div>

                        <div class="glass p-1 rounded-[2.5rem] min-h-[400px] shadow-xl flex flex-col relative overflow-hidden">
                            <div class="absolute inset-0 opacity-50 pointer-events-none" style="background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px;"></div>
                            
                            <div class="flex-1 overflow-y-auto p-6 relative z-10 pb-20">
                                ${state.messages.length ? msgList : `
                                    <div class="flex flex-col items-center justify-center h-full text-center text-slate-400 space-y-4 opacity-70">
                                        <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 19v-8.93a2 2 0 01.89-1.664l7.171-4.161a2 2 0 011.878 0l7.171 4.161a2 2 0 01.89 1.664V19a2 2 0 01-2 2h-14a2 2 0 01-2-2z"></path></svg>
                                        <p class="text-sm font-medium max-w-[200px]">${t.empty}</p>
                                    </div>
                                `}
                            </div>
                            
                            <div class="absolute bottom-0 w-full p-4 space-y-3 bg-white/90 backdrop-blur-md rounded-b-[2.5rem] border-t border-slate-100 z-20">
                                <button onclick="generatePDF()" class="w-full py-3 bg-slate-100 text-slate-600 font-bold rounded-xl text-sm hover:bg-slate-200 transition flex items-center justify-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    ${t.btnDl}
                                </button>
                                <button onclick="loadStudents(); setView('send')" class="w-full py-4 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition flex items-center justify-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                                    ${t.btnSend}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            // 4. SEND MESSAGE
            else if (state.view === 'send') {
                const filtered = state.students.filter(s => 
                    s.Full_name.toLowerCase().includes(state.searchQuery.toLowerCase()) && 
                    s.Full_name !== state.user.Full_name
                );

                app.innerHTML = `
                    <div class="glass p-6 rounded-[2rem] shadow-2xl space-y-4 ${dir} fade-in h-[85vh] flex flex-col">
                        <div class="flex justify-between items-center pb-2">
                            <h2 class="font-bold text-lg text-slate-800">${t.writeTitle}</h2>
                            <button onclick="setView('dashboard')" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-slate-200">&times;</button>
                        </div>
                        
                        <div class="relative">
                            <input oninput="updateSearch(this.value)" placeholder="${t.phSearch}" class="w-full p-4 pl-10 bg-slate-50 border-none rounded-2xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                            <svg class="w-4 h-4 text-slate-400 absolute left-3 top-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </div>

                        <div id="studentList" class="flex-1 overflow-y-auto space-y-2 pr-1 ${window.selectedRec ? 'hidden' : 'block'}">
                            ${filtered.map(s => `
                                <div onclick="selectRecipient('${s.Full_name}')" class="p-3 bg-white border border-slate-100 rounded-xl cursor-pointer hover:bg-indigo-50 hover:border-indigo-100 transition flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center text-xs font-bold">${s.Full_name.charAt(0)}</div>
                                    <span class="text-sm font-medium text-slate-700">${s.Full_name}</span>
                                </div>
                            `).join('')}
                        </div>

                        <div class="${window.selectedRec ? 'block' : 'hidden'} p-4 bg-indigo-50 text-indigo-700 rounded-xl font-bold text-center text-sm border border-indigo-100 flex items-center justify-between">
                            <span>To: ${window.selectedRec}</span>
                            <button onclick="updateSearch('')" class="text-xs underline opacity-60">Change</button>
                        </div>

                        <textarea id="msgContent" class="w-full h-40 p-4 bg-white border border-slate-200 rounded-2xl outline-none resize-none text-sm placeholder-slate-400 focus:border-indigo-500 transition" placeholder="${t.phMsg}"></textarea>
                        
                        <button onclick="sendMessage()" class="w-full py-4 bg-indigo-600 text-white font-bold rounded-2xl shadow-lg hover:bg-indigo-700 transition">${t.btnSubmit}</button>
                    </div>
                `;
            }
        }

        // --- 6. LOGIC & SECURITY ---

        async function handleLogin() {
            const rawName = document.getElementById('nameInput').value.trim();
            const pass = document.getElementById('passInput').value.trim();
            if(!rawName || !pass) return alert("Please fill all fields");

            const flexibleName = rawName.split(/\s+/).join('%');
            const { data, error } = await db.from('Students').select('*').ilike('Full_name', `%${flexibleName}%`).limit(1);

            if (error || !data || data.length === 0) return alert("Name not found. Please try again.");

            const user = data[0];
            if (!user.Password) {
                const { error: updateErr } = await db.from('Students').update({ Password: pass }).eq('id', user.id);
                if(updateErr) return alert("Error setting password.");
                alert(content[state.lang].alertPassSet);
            } else if (user.Password !== pass) {
                return alert(content[state.lang].alertPassErr);
            }

            state.user = user;
            await loadMessages(); // Secure load
            setupRealtime();      // Start listening for buzz
            setView('dashboard');
        }

        // --- SECURE MESSAGE LOADING ---
        async function loadMessages() {
            // CRITICAL: We explicitly SELECT ONLY 'content' and 'created_at'.
            // We do NOT select 'sender_name'.
            const { data } = await db
                .from('messages')
                .select('content, created_at') 
                .eq('recipient_name', state.user.Full_name)
                .order('created_at', { ascending: false });
                
            state.messages = data || [];
        }

        async function loadStudents() {
            if(state.students.length === 0) {
                const { data } = await db.from('Students').select('Full_name');
                state.students = data || [];
            }
        }

        // --- REALTIME BUZZ ---
        function setupRealtime() {
            if (state.realtimeSub) return;

            state.realtimeSub = db
                .channel('public:messages')
                .on('postgres_changes', { 
                    event: 'INSERT', 
                    schema: 'public', 
                    table: 'messages', 
                    filter: `recipient_name=eq.${state.user.Full_name}` 
                }, (payload) => {
                    // New message arrived!
                    // Security: We ignore payload content to be safe and re-fetch properly.
                    loadMessages().then(() => {
                        // If we are on dashboard, re-render to show new note
                        if (state.view === 'dashboard') render();
                        // Show Notification Toast
                        showToast(content[state.lang].newMsg);
                    });
                })
                .subscribe();
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-msg');
            toastMsg.innerText = msg;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 4000);
        }

        function updateSearch(val) { 
            state.searchQuery = val; 
            window.selectedRec = null; 
            render(); 
            const input = document.querySelector('input');
            if(input) { input.value = val; input.focus(); } 
        }

        function selectRecipient(name) { window.selectedRec = name; render(); }

        async function sendMessage() {
            const contentText = document.getElementById('msgContent').value.trim();
            if(!window.selectedRec || !contentText) return alert("Please select a person and write a message.");
            
            const { error } = await db.from('messages').insert({ 
                content: contentText, 
                recipient_name: window.selectedRec, 
                sender_name: state.user.Full_name 
            });

            if(error) { 
                console.error(error); 
                alert("Error sending message."); 
            } else { 
                // CONFETTI BURST
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#6366f1', '#f43f5e', '#fef08a'],
                    shapes: ['circle', 'square'] // Simple shapes look cleaner
                });

                alert(content[state.lang].alertSent); 
                window.selectedRec = null; 
                state.searchQuery = '';
                setView('dashboard'); 
            }
        }

        // --- UPGRADED PDF GENERATION ---
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();

            // 1. ADD A DECORATIVE BORDER
            doc.setDrawColor(79, 70, 229); // Indigo
            doc.setLineWidth(1);
            doc.rect(5, 5, pageWidth - 10, pageHeight - 10); // Outer border
            doc.setLineWidth(0.2);
            doc.rect(7, 7, pageWidth - 14, pageHeight - 14); // Inner thin border

            // 2. HEADER: CLASS OF 2025
            doc.setFillColor(79, 70, 229);
            doc.rect(0, 20, pageWidth, 25, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont("helvetica", "bold");
            doc.setFontSize(24);
            doc.text("THE APPRECIATION ENVELOPE", pageWidth / 2, 33, { align: "center" });
            
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text("Class of 2025 â€¢ Memories of Kindness", pageWidth / 2, 40, { align: "center" });

            // 3. RECIPIENT NAME
            doc.setTextColor(30, 41, 59);
            doc.setFontSize(18);
            doc.setFont("helvetica", "bold");
            doc.text(`For: ${state.user.Full_name}`, 20, 65);

            // 4. THE MESSAGES (STATIONERY STYLE)
            let y = 80;
            doc.setFontSize(11);
            
            if(state.messages.length === 0) {
                doc.setFont("helvetica", "italic");
                doc.text("This envelope is waiting to be filled with kind words...", 20, y);
            } else {
                state.messages.forEach((msg, i) => {
                    // Check for new page
                    if (y > 260) { 
                        doc.addPage(); 
                        // Redraw borders on new page
                        doc.setDrawColor(79, 70, 229);
                        doc.rect(5, 5, pageWidth - 10, pageHeight - 10);
                        y = 30; 
                    }

                    // Draw a "Sticky Note" box
                    doc.setDrawColor(226, 232, 240);
                    doc.setFillColor(248, 250, 252);
                    doc.roundedRect(15, y, pageWidth - 30, 20, 2, 2, 'FD');
                    
                    // Text inside
                    doc.setTextColor(51, 65, 85);
                    doc.setFont("helvetica", "italic");
                    const splitText = doc.splitTextToSize(`"${msg.content}"`, pageWidth - 40);
                    doc.text(splitText, 20, y + 12);
                    
                    y += 28;
                });
            }

            // 5. FOOTER
            doc.setTextColor(148, 163, 184);
            doc.setFontSize(8);
            doc.setFont("helvetica", "normal");
            doc.text("Generated by the Class Portal â€¢ 100% Anonymous", pageWidth / 2, pageHeight - 15, { align: "center" });

            doc.save(`${state.user.Full_name}_Appreciation_2025.pdf`);
        }

        // Initialize
        render();

    </script>
</body>
</html>
