<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4f46e5">
    <meta name="description" content="Secure Class Appreciation Portal | v2.6.0-Enterprise">
    <meta name="application-name" content="Anomiac Portal">
    <title>The Appreciation Envelope | Enterprise Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Caveat:wght@600&family=Playfair+Display:ital,wght@0,600;1,600&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #3730a3;
            --secondary: #f43f5e;
            --accent: #fef08a;
            --bg-grad-start: #f8fafc;
            --bg-grad-end: #e2e8f0;
            --glass-border: rgba(255, 255, 255, 0.6);
            --glass-surface: rgba(255, 255, 255, 0.85);
            --shadow-elevation-1: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --shadow-elevation-2: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* --- GLOBAL RESET & BASE --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg-grad-start);
            color: #0f172a;
            overflow-x: hidden;
            min-height: 100vh;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
        }

        /* --- BACKGROUND FX ENGINE --- */
        .fx-aurora {
            position: fixed; inset: 0; z-index: -2;
            background: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-size: 200% 200%;
            animation: aurora-drift 20s ease infinite alternate;
        }
        .fx-overlay {
            position: fixed; inset: 0; z-index: -1;
            background: rgba(255, 255, 255, 0.88);
            backdrop-filter: blur(60px);
        }

        @keyframes aurora-drift {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }

        /* --- COMPONENT: GLASS CARD --- */
        .glass-card {
            background: var(--glass-surface);
            backdrop-filter: blur(24px) saturate(180%);
            border: 1px solid var(--glass-border);
            box-shadow: 
                var(--shadow-elevation-1),
                0 0 0 1px rgba(255, 255, 255, 0.4) inset;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        /* --- COMPONENT: INPUT FIELDS --- */
        .input-field {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(203, 213, 225, 0.8);
            transition: all 0.25s ease;
        }
        .input-field:focus {
            background: #fff;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.15);
            transform: translateY(-2px);
        }

        /* --- COMPONENT: ACTION BUTTONS --- */
        .btn-action {
            position: relative; overflow: hidden;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3);
        }
        .btn-action:active { transform: scale(0.96); }
        .btn-action::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(255,255,255,0.2), transparent);
            opacity: 0; transition: opacity 0.2s;
        }
        .btn-action:hover::after { opacity: 1; }

        /* --- VISUAL STATIONERY THEMES --- */
        .note-sticky {
            background: linear-gradient(135deg, #fef9c3 0%, #fef08a 100%);
            font-family: 'Caveat', cursive; font-size: 1.4rem; color: #422006;
            border-bottom-right-radius: 60px 15px;
            box-shadow: 2px 4px 8px rgba(0,0,0,0.06);
        }
        .note-card {
            background: #fff;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 16px 16px;
            font-family: 'Inter', sans-serif; font-size: 0.95rem; color: #334155;
            border-top: 4px solid var(--secondary);
        }
        .note-elegant {
            background: #fafaf9; border: 1px solid #e7e5e4;
            font-family: 'Playfair Display', serif; font-style: italic; color: #1c1917;
            padding: 2rem; text-align: center;
        }

        /* --- ANIMATION SEQUENCER --- */
        .anim-enter { animation: slide-up 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        .delay-1 { animation-delay: 0.1s; }
        .delay-2 { animation-delay: 0.2s; }
        .delay-3 { animation-delay: 0.3s; }

        @keyframes slide-up {
            from { opacity: 0; transform: translateY(30px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* --- UTILITIES --- */
        .rtl { direction: rtl; text-align: right; }
        .ltr { direction: ltr; text-align: left; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* --- NOTIFICATION TOAST (CRITICAL: pointer-events-none) --- */
        #sys-toast {
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            transform: translate(-50%, 100px); opacity: 0;
            pointer-events: none; /* Allows clicks to pass through when invisible */
        }
        #sys-toast.active { transform: translate(-50%, -20px); opacity: 1; pointer-events: auto; }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-4">

    <div class="fx-aurora"></div>
    <div class="fx-overlay"></div>

    <div id="app-root" class="w-full max-w-md relative z-10 min-h-[400px] flex flex-col justify-center">
        <div class="text-center animate-pulse">
            <div class="w-16 h-16 bg-white/50 rounded-full mx-auto mb-4"></div>
            <div class="h-4 w-32 bg-white/50 rounded mx-auto"></div>
        </div>
    </div>

    <div id="sys-toast" class="fixed bottom-0 left-1/2 z-50 flex items-center gap-3 px-6 py-3 bg-slate-800 text-white rounded-full shadow-2xl">
        <span class="text-xl">üîî</span>
        <span id="toast-text" class="text-sm font-semibold pr-2">System Notification</span>
    </div>

    <div class="fixed bottom-4 w-full text-center pointer-events-none z-0 opacity-60">
        <p class="text-[10px] font-mono text-slate-500 uppercase tracking-widest">
            <span class="inline-block w-2 h-2 bg-green-500 rounded-full mr-1"></span>
            RLS Secured ‚Ä¢ End-to-End Anonymous
        </p>
    </div>

    <script>
        /**
         * ANOMIAC PORTAL - ENTERPRISE ARCHITECTURE
         * v2.6.0 Build 2025.12.31
         * * MODULE MAP:
         * 1. Config  : Environment variables & Constants
         * 2. DB      : Supabase Connection Layer
         * 3. State   : Reactive Data Store
         * 4. I18n    : Internationalization Engine
         * 5. UI      : Rendering & Visual Logic
         * 6. Actions : Business Logic & Event Handlers
         */

        // --- MODULE 1: CONFIGURATION ---
        const Config = {
            SUPABASE_URL: 'https://ijgtdeffemmvuezkkfri.supabase.co',
            SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlqZ3RkZWZmZW1tdnVlemtrZnJpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMTI5MzEsImV4cCI6MjA4MjU4ODkzMX0.x-nO59Smnq2Sk-Q_rVOM3oPuVmur5nTpgwZntJJEFxY',
            VERSION: '2.6.0',
            ANIMATION_SPEED: 400
        };

        // --- MODULE 2: DATABASE LAYER ---
        const DB = window.supabase.createClient(Config.SUPABASE_URL, Config.SUPABASE_KEY);
        
        // System Boot Log
        console.log(`%c ANOMIAC ENTERPRISE %c v${Config.VERSION} `, 'background:#4f46e5; color:white; padding:4px; border-radius:4px;', 'color:#4f46e5;');
        console.log('System Status: Online. RLS: Active. Realtime: Enabled.');

        // --- MODULE 3: STATE MANAGEMENT ---
        const State = {
            view: 'welcome', // 'welcome', 'login', 'dashboard', 'send'
            lang: 'en',      // 'en', 'fr', 'ar'
            user: null,      // Current Logged In User
            cache: {
                students: [], // Cached list of classmates
                messages: []  // Cached list of received messages
            },
            subscriptions: null // Realtime socket reference
        };

        // --- MODULE 4: INTERNATIONALIZATION (I18N) ---
        const I18n = {
            en: {
                title: "A Single Word Can Change a Life",
                subtitle: "Decades ago, a soldier's most prized possession was a list of compliments from his classmates. Today, we create that list for you.",
                start: "Initialize Portal",
                login_h: "Identity Verification",
                name_ph: "Full Name (e.g., Achour Yacine)",
                pass_ph: "Security Password",
                unlock: "Authenticate",
                cancel: "Abort",
                welcome: "Welcome,",
                empty_t: "Envelope Status: Empty",
                empty_d: "No messages detected yet. Check back later.",
                act_write: "Compose Message",
                act_pdf: "Export Certificate",
                write_h: "Select Recipient",
                search_ph: "Search database...",
                msg_ph: "Write a genuine compliment. What do you admire about them?",
                send: "Encrypt & Send",
                toast_sent: "Message delivered securely.",
                toast_new: "New encrypted message received.",
                err_name: "User not found in registry.",
                err_pass: "Authentication failed.",
                change: "Modify",
                loading: "Loading Database..."
            },
            fr: {
                title: "Un seul mot peut changer une vie",
                subtitle: "Il y a des d√©cennies, la possession la plus pr√©cieuse d'un soldat √©tait une liste de compliments de ses camarades. Aujourd'hui, nous cr√©ons cette liste.",
                start: "Initialiser le portail",
                login_h: "V√©rification d'identit√©",
                name_ph: "Nom complet (ex. Achour Yacine)",
                pass_ph: "Mot de passe de s√©curit√©",
                unlock: "Authentifier",
                cancel: "Annuler",
                welcome: "Bienvenue,",
                empty_t: "√âtat de l'enveloppe : Vide",
                empty_d: "Aucun message d√©tect√©. Revenez plus tard.",
                act_write: "R√©diger un message",
                act_pdf: "Exporter le certificat",
                write_h: "S√©lectionner le destinataire",
                search_ph: "Rechercher dans la base...",
                msg_ph: "√âcrivez un compliment sinc√®re. Qu'admirez-vous chez eux ?",
                send: "Chiffrer et Envoyer",
                toast_sent: "Message livr√© en toute s√©curit√©.",
                toast_new: "Nouveau message chiffr√© re√ßu.",
                err_name: "Utilisateur introuvable.",
                err_pass: "√âchec de l'authentification.",
                change: "Modifier",
                loading: "Chargement..."
            },
            ar: {
                title: "ŸÉŸÑŸÖÿ© Ÿàÿßÿ≠ÿØÿ© ŸÇÿØ ÿ™ÿ∫Ÿäÿ± ÿ≠Ÿäÿßÿ© ÿ®ÿ£ŸÉŸÖŸÑŸáÿß",
                subtitle: "ŸÖŸÜÿ∞ ÿπŸÇŸàÿØÿå ŸÉÿßŸÜÿ™ ÿ£ÿ∫ŸÑŸâ ŸÖÿß ŸäŸÖŸÑŸÉŸá ÿ¨ŸÜÿØŸä ŸáŸä Ÿàÿ±ŸÇÿ© ÿ™ÿ≠ŸÖŸÑ ŸÉŸÑŸÖÿßÿ™ ÿ™ŸÇÿØŸäÿ± ŸÖŸÜ ÿ≤ŸÖŸÑÿßÿ¶Ÿá. ÿßŸÑŸäŸàŸÖÿå ŸÜÿ≠ŸÜ ŸÜÿπŸäÿØ ŸÉÿ™ÿßÿ®ÿ© ÿ™ŸÑŸÉ ÿßŸÑŸàÿ±ŸÇÿ© ŸÑŸÉ.",
                start: "ÿ®ÿØÿ° ÿßŸÑŸÜÿ∏ÿßŸÖ",
                login_h: "ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸáŸàŸäÿ©",
                name_ph: "ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ (ŸÖÿ´ÿßŸÑ: ÿπÿßÿ¥Ÿàÿ± Ÿäÿßÿ≥ŸäŸÜ)",
                pass_ph: "ÿ±ŸÖÿ≤ ÿßŸÑÿ≠ŸÖÿßŸäÿ©",
                unlock: "ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿØÿÆŸàŸÑ",
                cancel: "ÿ•ŸÑÿ∫ÿßÿ°",
                welcome: "ŸÖÿ±ÿ≠ÿ®ÿßŸãÿå",
                empty_t: "ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ∫ŸÑŸÅ: ŸÅÿßÿ±ÿ∫",
                empty_d: "ŸÑŸÖ ÿ™ÿµŸÑŸÉ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿ®ÿπÿØ. ÿπÿØ ŸÑÿßÿ≠ŸÇÿßŸã.",
                act_write: "ŸÉÿ™ÿßÿ®ÿ© ÿ±ÿ≥ÿßŸÑÿ©",
                act_pdf: "ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑÿ¥ŸáÿßÿØÿ©",
                write_h: "ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ±ÿ≥ŸÑ ÿ•ŸÑŸäŸá",
                search_ph: "ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÇÿßÿ¶ŸÖÿ©...",
                msg_ph: "ÿßŸÉÿ™ÿ® ÿ¥Ÿäÿ¶ÿßŸã ÿµÿßÿØŸÇÿßŸã. ŸÖÿß ÿßŸÑÿ∞Ÿä Ÿäÿπÿ¨ÿ®ŸÉ ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑÿ¥ÿÆÿµÿü",
                send: "ÿ™ÿ¥ŸÅŸäÿ± Ÿàÿ•ÿ±ÿ≥ÿßŸÑ",
                toast_sent: "ÿ™ŸÖ ÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ÿ®ŸÜÿ¨ÿßÿ≠.",
                toast_new: "ŸàÿµŸÑÿ™ŸÉ ÿ±ÿ≥ÿßŸÑÿ© ŸÖÿ¥ŸÅÿ±ÿ© ÿ¨ÿØŸäÿØÿ©.",
                err_name: "ÿßŸÑÿßÿ≥ŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ÿßŸÑÿ≥ÿ¨ŸÑ.",
                err_pass: "ÿÆÿ∑ÿ£ ŸÅŸä ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±.",
                change: "ÿ™ÿ∫ŸäŸäÿ±",
                loading: "ÿ¨ÿßÿ± ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ..."
            }
        };

        // --- MODULE 5: UI RENDERER SYSTEM ---
        const UI = {
            root: document.getElementById('app-root'),
            
            // Helper: Get Translation
            t: () => I18n[State.lang],
            
            // Helper: Determine Direction
            dir: () => State.lang === 'ar' ? 'rtl' : 'ltr',
            
            // Helper: Randomize Paper Style for Organic Feel
            getPaperStyle: (idx) => {
                const types = ['note-sticky', 'note-card', 'note-elegant'];
                const rot = ((idx * 17) % 5) - 2; // Pseudo-random rotation -2 to +2
                return { class: types[idx % types.length], rot: `rotate(${rot}deg)` };
            },

            // SCREEN 1: Welcome
            renderWelcome: () => {
                const t = UI.t();
                UI.root.innerHTML = `
                    <div class="glass-card p-8 rounded-[2.5rem] text-center space-y-8 anim-enter ${UI.dir()}">
                        <div class="w-20 h-20 bg-gradient-to-tr from-indigo-100 to-white rounded-full flex items-center justify-center mx-auto shadow-xl ring-4 ring-white/50">
                            <span class="text-4xl">‚úâÔ∏è</span>
                        </div>
                        <div class="space-y-4">
                            <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight leading-tight">${t.title}</h1>
                            <p class="text-slate-600 text-sm leading-relaxed font-medium mx-auto max-w-xs opacity-80">${t.subtitle}</p>
                        </div>
                        <button onclick="Actions.nav('login')" class="w-full py-4 btn-action text-white font-bold rounded-2xl text-lg tracking-wide">${t.start}</button>
                        
                        <div class="flex justify-center gap-2 pt-4">
                            ${['en','fr','ar'].map(l => `
                                <button onclick="Actions.setLang('${l}')" class="px-3 py-1 rounded-md text-xs font-bold uppercase tracking-wider transition-colors ${State.lang===l ? 'bg-indigo-100 text-indigo-700' : 'text-slate-400 hover:text-slate-600'}">${l}</button>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            // SCREEN 2: Login
            renderLogin: () => {
                const t = UI.t();
                UI.root.innerHTML = `
                    <div class="glass-card p-8 rounded-[2.5rem] space-y-6 anim-enter ${UI.dir()}">
                        <div class="text-center pb-2">
                            <h2 class="text-xl font-bold text-slate-900">${t.login_h}</h2>
                            <div class="h-1 w-12 bg-indigo-500 rounded-full mx-auto mt-2"></div>
                        </div>
                        <div class="space-y-4">
                            <div class="group">
                                <input id="inp-name" type="text" placeholder="${t.name_ph}" class="w-full p-4 rounded-2xl input-field outline-none text-slate-800 font-medium placeholder-slate-400/70">
                            </div>
                            <div class="group">
                                <input id="inp-pass" type="password" placeholder="${t.pass_ph}" class="w-full p-4 rounded-2xl input-field outline-none text-slate-800 font-medium placeholder-slate-400/70">
                            </div>
                        </div>
                        <div class="space-y-3 pt-2">
                            <button onclick="Actions.login()" class="w-full py-4 btn-action text-white font-bold rounded-2xl text-lg shadow-xl hover:shadow-2xl transition-shadow">${t.unlock}</button>
                            <button onclick="Actions.nav('welcome')" class="w-full py-2 text-xs font-bold text-slate-400 hover:text-slate-600 tracking-widest uppercase">${t.cancel}</button>
                        </div>
                    </div>
                `;
            },

            // SCREEN 3: Dashboard (Messages)
            renderDashboard: () => {
                const t = UI.t();
                const msgs = State.cache.messages;
                
                const msgHTML = msgs.map((m, i) => {
                    const style = UI.getPaperStyle(i);
                    return `
                    <div class="p-6 mb-6 rounded-xl ${style.class} anim-enter" style="animation-delay: ${i*0.1}s; transform: ${style.rot};">
                        <p class="leading-relaxed whitespace-pre-wrap">"${m.content}"</p>
                    </div>`;
                }).join('');

                const emptyHTML = `
                    <div class="glass-card rounded-3xl p-10 text-center flex flex-col items-center justify-center min-h-[300px] border-dashed border-2 border-slate-300 bg-slate-50/30">
                        <div class="w-16 h-16 bg-slate-200 rounded-full flex items-center justify-center mb-4 text-2xl animate-bounce">üì≠</div>
                        <h3 class="font-bold text-slate-700 text-lg">${t.empty_t}</h3>
                        <p class="text-slate-500 text-sm mt-2 max-w-[200px]">${t.empty_d}</p>
                    </div>
                `;

                UI.root.innerHTML = `
                    <div class="space-y-6 ${UI.dir()} w-full pb-32 anim-enter">
                        <div class="flex justify-between items-end px-4 pt-2">
                            <div>
                                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">${t.welcome}</p>
                                <h2 class="text-3xl font-extrabold text-slate-900 tracking-tight">${State.user.Full_name.split(' ')[0]}</h2>
                            </div>
                            <button onclick="location.reload()" class="w-10 h-10 flex items-center justify-center bg-white/50 hover:bg-red-50 text-slate-400 hover:text-red-500 rounded-full transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                            </button>
                        </div>

                        <div class="relative min-h-[50vh] px-2">
                            ${msgs.length ? msgHTML : emptyHTML}
                        </div>
                    </div>

                    <div class="fixed bottom-8 left-0 w-full px-4 z-40">
                        <div class="max-w-md mx-auto bg-white/90 backdrop-blur-xl p-2 rounded-2xl shadow-2xl border border-white/50 flex gap-2">
                            <button onclick="Actions.generatePDF()" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold rounded-xl text-xs sm:text-sm transition flex items-center justify-center gap-2">
                                <span>üìÑ</span> ${t.act_pdf}
                            </button>
                            <button id="btn-compose-trigger" onclick="Actions.openCompose()" class="flex-[1.5] py-3 btn-action text-white font-bold rounded-xl text-xs sm:text-sm shadow-lg flex items-center justify-center gap-2">
                                <span>‚úçÔ∏è</span> ${t.act_write}
                            </button>
                        </div>
                    </div>
                `;
            },

            // SCREEN 4: Send Message
            renderSend: () => {
                const t = UI.t();
                // Filter Logic for Recipient Search
                const term = (State.searchQuery || '').toLowerCase();
                const filtered = State.cache.students.filter(s => 
                    s.Full_name.toLowerCase().includes(term) && 
                    s.Full_name !== State.user.Full_name
                );

                const listHTML = filtered.map(s => `
                    <div onclick="Actions.selectRecipient('${s.Full_name}')" class="p-3 bg-white/60 border border-white hover:border-indigo-300 rounded-2xl cursor-pointer transition-all duration-200 flex items-center gap-4 group">
                        <div class="w-10 h-10 rounded-full bg-indigo-100 text-indigo-700 flex items-center justify-center font-bold text-sm shadow-sm group-hover:scale-110 transition-transform">${s.Full_name.charAt(0)}</div>
                        <span class="font-semibold text-slate-700 text-sm">${s.Full_name}</span>
                    </div>
                `).join('');

                UI.root.innerHTML = `
                    <div class="glass-card p-6 rounded-[2.5rem] h-[85vh] flex flex-col anim-enter ${UI.dir()} relative">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="font-bold text-lg text-slate-900">${t.write_h}</h2>
                            <button onclick="Actions.nav('dashboard')" class="w-8 h-8 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-500 transition">‚úï</button>
                        </div>
                        
                        <div class="relative mb-4">
                            <input oninput="Actions.updateSearch(this.value)" placeholder="${t.search_ph}" class="w-full p-3 pl-10 bg-white border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none shadow-sm transition-all">
                            <span class="absolute left-3 top-3 text-slate-400">üîç</span>
                        </div>

                        <div class="flex-1 overflow-y-auto space-y-2 pr-1 mb-4 scroll-smooth hide-scrollbar ${window.selectedRec ? 'hidden' : 'block'}">
                            ${listHTML}
                        </div>

                        <div class="${window.selectedRec ? 'flex' : 'hidden'} items-center justify-between p-3 bg-indigo-50 border border-indigo-100 rounded-xl mb-4 anim-enter">
                            <div class="flex items-center gap-3">
                                <div class="w-6 h-6 rounded-full bg-indigo-500 text-white flex items-center justify-center font-bold text-[10px]">‚úì</div>
                                <span class="font-bold text-indigo-900 text-sm">${window.selectedRec}</span>
                            </div>
                            <button onclick="Actions.updateSearch('')" class="text-[10px] font-bold text-indigo-400 hover:text-indigo-600 uppercase tracking-wide">${t.change}</button>
                        </div>

                        <textarea id="inp-msg" class="w-full h-32 p-4 bg-white border border-slate-200 rounded-2xl outline-none resize-none text-sm placeholder-slate-400 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all shadow-inner font-medium text-slate-700" placeholder="${t.msg_ph}"></textarea>
                        
                        <button onclick="Actions.sendMessage()" class="w-full py-3 mt-4 btn-action text-white font-bold rounded-xl text-lg shadow-xl">${t.send}</button>
                    </div>
                `;
            },

            // Notification Toaster
            toast: (msg) => {
                const el = document.getElementById('sys-toast');
                document.getElementById('toast-text').innerText = msg;
                el.classList.add('active');
                setTimeout(() => el.classList.remove('active'), 4000);
            }
        };

        // --- MODULE 6: BUSINESS LOGIC (ACTIONS) ---
        const Actions = {
            init: () => {
                // Initialize Application
                UI.renderWelcome();
            },

            nav: (view) => {
                // Navigation Router
                State.view = view;
                switch(view) {
                    case 'welcome': UI.renderWelcome(); break;
                    case 'login': UI.renderLogin(); break;
                    case 'dashboard': UI.renderDashboard(); break;
                    case 'send': UI.renderSend(); break;
                }
            },

            setLang: (l) => {
                State.lang = l;
                UI.renderWelcome(); // Re-render to apply language
            },

            // --- BUG FIX: COMPOSE BUTTON LOGIC ---
            openCompose: async () => {
                // 1. Provide visual feedback
                const btn = document.getElementById('btn-compose-trigger');
                if(btn) btn.innerText = UI.t().loading;

                try {
                    // 2. Load Student List IF not cached
                    if (!State.cache.students.length) {
                        const { data } = await DB.from('Students').select('Full_name');
                        State.cache.students = data || [];
                    }
                    // 3. Switch View
                    Actions.nav('send');
                } catch (e) {
                    console.error("Critical Load Error:", e);
                    if(btn) btn.innerText = "Error";
                }
            },

            login: async () => {
                const name = document.getElementById('inp-name').value.trim();
                const pass = document.getElementById('inp-pass').value.trim();
                
                if (!name || !pass) return alert("Credentials required.");

                try {
                    // Flexible Search Algorithm (Spaces -> Wildcards)
                    const flexName = name.split(/\s+/).join('%');
                    const { data, error } = await DB
                        .from('Students')
                        .select('*')
                        .ilike('Full_name', `%${flexName}%`)
                        .limit(1);

                    if (error || !data.length) throw new Error('User_Not_Found');

                    const user = data[0];

                    // Password Handling Protocol
                    if (!user.Password) {
                        // First-time Setup
                        await DB.from('Students').update({ Password: pass }).eq('id', user.id);
                    } else if (user.Password !== pass) {
                        throw new Error('Invalid_Pass');
                    }

                    // Success Protocol
                    State.user = user;
                    await Actions.syncMessages();
                    Actions.initRealtime();
                    Actions.nav('dashboard');

                } catch (e) {
                    console.error("Auth Error:", e);
                    const t = UI.t();
                    alert(e.message === 'User_Not_Found' ? t.err_name : t.err_pass);
                }
            },

            syncMessages: async () => {
                // Secure Fetch: Only content & timestamp (No Sender ID)
                const { data } = await DB
                    .from('messages')
                    .select('content, created_at')
                    .eq('recipient_name', State.user.Full_name)
                    .order('created_at', { ascending: false });
                
                State.cache.messages = data || [];
            },

            updateSearch: (val) => {
                State.searchQuery = val;
                window.selectedRec = null;
                UI.renderSend();
                // Maintain Input Focus
                const el = document.querySelector('input');
                if (el) { el.value = val; el.focus(); }
            },

            selectRecipient: (name) => {
                window.selectedRec = name;
                UI.renderSend();
            },

            sendMessage: async () => {
                const txt = document.getElementById('inp-msg').value.trim();
                if (!window.selectedRec || !txt) return;

                const payload = {
                    content: txt,
                    recipient_name: window.selectedRec,
                    sender_name: State.user.Full_name // Logged securely
                };

                const { error } = await DB.from('messages').insert(payload);

                if (!error) {
                    // Reward Feedback
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#6366f1', '#f43f5e', '#fef08a'] });
                    UI.toast(UI.t().toast_sent);
                    
                    // Reset View
                    window.selectedRec = null; 
                    State.searchQuery = '';
                    Actions.nav('dashboard');
                }
            },

            initRealtime: () => {
                if (State.subscriptions) return;
                
                State.subscriptions = DB
                    .channel('public:messages')
                    .on('postgres_changes', { 
                        event: 'INSERT', 
                        schema: 'public', 
                        table: 'messages', 
                        filter: `recipient_name=eq.${State.user.Full_name}` 
                    }, () => {
                        // Live Reload
                        Actions.syncMessages().then(() => {
                            if (State.view === 'dashboard') UI.renderDashboard();
                            UI.toast(UI.t().toast_new);
                        });
                    })
                    .subscribe();
            },

            generatePDF: () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const W = doc.internal.pageSize.getWidth();
                const H = doc.internal.pageSize.getHeight();

                // Certificate Styling
                doc.setDrawColor(79, 70, 229); doc.setLineWidth(1); doc.rect(5, 5, W-10, H-10);
                doc.setLineWidth(0.2); doc.rect(7, 7, W-14, H-14);

                doc.setFillColor(79, 70, 229); doc.rect(0, 20, W, 25, 'F');
                doc.setTextColor(255); doc.setFont("helvetica", "bold"); doc.setFontSize(24);
                doc.text("THE APPRECIATION ENVELOPE", W/2, 33, { align: "center" });
                
                doc.setFontSize(12); doc.setFont("helvetica", "normal");
                doc.text("Class of 2025 ‚Ä¢ Memories of Kindness", W/2, 40, { align: "center" });

                doc.setTextColor(30, 41, 59); doc.setFontSize(18); doc.setFont("helvetica", "bold");
                doc.text(`For: ${State.user.Full_name}`, 20, 65);

                let y = 85; 
                State.cache.messages.forEach(m => {
                    if(y > 250) { doc.addPage(); y=30; }
                    doc.setDrawColor(200); doc.setFillColor(248, 250, 252);
                    doc.roundedRect(15, y, W-30, 20, 3, 3, 'FD');
                    doc.setTextColor(50); doc.setFontSize(10); doc.setFont("helvetica", "italic");
                    doc.text(doc.splitTextToSize(`"${m.content}"`, W-40), 20, y+8);
                    y += 25;
                });
                
                doc.save("Certificate_2025.pdf");
            }
        };

        // --- SYSTEM BOOT ---
        window.onload = Actions.init;
        window.Actions = Actions; // Expose to HTML

    </script>
</body>
</html>
